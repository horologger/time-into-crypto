<!DOCTYPE html>
<html lang="en" dir="ltr">
    <head>
    <meta charset="utf-8" />
    <title>Web Socket Demo</title>
    <script>
    function log(message)
    {
        console.log(message);
        var loggdiv = document.getElementById("logger");
        if (loggdiv) {
            loggdiv.innerHTML = loggdiv.innerHTML + "\n" + message;
            loggdiv.scrollTop = loggdiv.scrollHeight;
        }
    }
    </script>

    <script>
    (function () {
        var onWindowLoad = function () {
            
            var loadScript = function (src, callback) {
            
                var element = document.createElement("script");
                    element.src = src;
                    element.async = true;
                    document.body.appendChild(element);
                    
                    if (callback) {
                    
                        element.onreadystatechange = function () {
                            if (this.readyState === "loaded" || this.readyState === "complete") { 
                                callback();
                            }
                        };
                        element.onload = callback;
                    }
            },
            
            loadArticleScript = function () {
                // checkForAuthToken();
            };
            loadScript("jquery.min.js", loadArticleScript);
        };

        if (window.addEventListener) {
            window.addEventListener("load", onWindowLoad, false);
        } else if (window.attachEvent) {
            window.attachEvent("onload", onWindowLoad);
        } else {
            window.onload = onWindowLoad;
        }
    }());			

    function doGetNick()
    {

        var pathAndParams = '{{base}}/getNickFromPubKey';

        xhr = new XMLHttpRequest();
        xhr.open('POST', pathAndParams);

        xhr.setRequestHeader("Content-Type", "application/json");
        xhr.setRequestHeader("Accept", "application/json");

        var request_obj = { 
            "pubkey": document.getElementById("lnpubkey-field").value
        };

        xhr.onload = function() {
            
            if (xhr.status == 200) {

                var isJsonBody = false;
                var headers = xhr.getAllResponseHeaders();
                const hdrs = headers.split('\r\n');
                hdrs.forEach(function(hdr){
                    var parts = hdr.split(':');
                    if (parts[0] == "content-type") {
                        var bits = parts[1].split(';');
                        if (bits[0].trim() == "application/json") {
                            isJsonBody = true;
                        }
                    }
                });

                if (isJsonBody) {
                    var response = JSON.parse(xhr.responseText);
                    log(response);
                    document.getElementById("nick").value = response.nick;
                    // if (window.location.href.search("tenantid") < 0) {
                    //     window.location.href = window.location.href + "?tenantid=" + response.tenant;
                    // }
                }
            } 
            else {
                document.getElementById("nick").innerHTML = "Unexpected";
            }
        };

        xhr.send(JSON.stringify(request_obj));

    }

    async function getLNPubKey(req, res) {
        try {
            // const webln = await WebLN.requestProvider();
            const info = await window.webln.getInfo();
            if (typeof info.node.pubkey == 'undefined') {
                document.getElementById("lnpubkey-field").value = "Alby accounts do not have a pubkey.";
            } else {
                document.getElementById("lnpubkey-field").value = info.node.pubkey;
            }
            document.getElementById("nick").value = info.node.alias;
            // doGetNick();
        }
        catch(err) {
            // Tell the user what went wrong
            log(err.message);
            alert(err.message);
        }
    };

    async function enableWebLN() {
        log("enabling WebLN");
        await window.webln.enable();
        log("WebLN enabled");
        await getLNPubKey(null, null);
        log("got LNPubKey");
        await getNostrPubKey();
        log("got NostrPubKey");
        
    };

    // https://github.com/getAlby/js-sdk
    function existsWebLN() {
        // if (((typeof window.webln) == "object") && ((typeof window.webln.enabled) == "boolean")) {
        if (typeof window.webln !== 'undefined') {
            document.getElementById("prereqs").style.display = "none";
            document.getElementById("mainsection").style.display = "block";
            log("WebLN found");
            (async function() {
                await enableWebLN();
            })();
        }
        else {
            document.getElementById("prereqs").style.display = "block";
            document.getElementById("mainsection").style.display = "none";
            log("WebLN not found");
        }
    };

    var nostrPubKey = "unknown";

    var loc_href = "http://localhost:8080/?hpk=7bde...72a5&relay=wss://domas.io";   // urlencoded??
    var loc_proto = "http:";
    var loc_host = "localhost:8080";    // actually host:port
    var loc_http = "http://localhost:8080";
    var hpk = "aaabbb";
    var relay = "wss://relay.primal.net"

    function getHrefParts() {
        log("getHrefParts");
        loc_href = window.document.location.href;
        log("loc_href: " + loc_href);
        loc_proto = window.document.location.protocol;
        log("loc_proto: " + loc_proto);
        loc_host = window.document.location.host;
        log("loc_host: " + loc_host);
        loc_http = window.document.location.origin;
        const queryString = window.location.search;
        console.log(queryString);
        const urlParams = new URLSearchParams(queryString);

        if (urlParams.has('hpk')) {
            hpk = urlParams.get('hpk');
        } else {
            hpk = nostrPubKey;
        }

        log("hpk: " + hpk);

        if (urlParams.has('relay')) {   // wss%3A%2F%2Frelay.getalby.com%2Fv1
            relay = urlParams.get('relay');
        }
        log("relay: " + relay);

        // if (loc_href.search("hpk") > 0) {
        //     var sched_link = loc_http + "?hpk=" + nostrPubKey;
        //     document.getElementById("schedule-link").href = sched_link;
        //     document.getElementById("schedule-link").innerHTML = "My Schedule Link: " + sched_link;
        //     if (hpk != nostrPubKey) {
        //         document.getElementById("mode-button").innerHTML = "Mode: Guest";
        //     } else {
        //         document.getElementById("mode-button").innerHTML = "Mode: Host";
        //     }
        // }
        // else {
        //     loc_http = loc_href.split("?")[0];
        //     log("loc_http: " + loc_http);
        //     var sched_link = loc_http + "?hpk=" + nostrPubKey;
        //     document.getElementById("schedule-link").href = sched_link;
        //     document.getElementById("schedule-link").innerHTML = "My Schedule Link: " + sched_link;
        //     document.getElementById("mode-button").innerHTML = "Mode: Host";
        // }
    }

    getHrefParts();

    function setScheduleLink() {
        log("setScheduleLink");
        var sched_link = loc_http + "/?hpk=" + nostrPubKey + "&relay=" + relay;
            document.getElementById("schedule-link").href = sched_link;
            document.getElementById("schedule-link").innerHTML = "My Schedule Link: " + sched_link;
            if (hpk != nostrPubKey) {
                document.getElementById("mode-button").innerHTML = "Mode: Reservation";
            } else {
                document.getElementById("mode-button").innerHTML = "Mode: Availablity";
                // document.getElementById("mode-button").innerHTML = "Mode: Confirmation";
            }
    }

    function switchMode() {
        log("switchMode");
    }

    var connection = null;

    function reconnect() {

        var wsproto = "wss:";
        if (loc_proto == "http:") {
            wsproto = "ws:";
        }
        connection = new WebSocket(wsproto + "//" + loc_host + "/?" + "shpk=" + hpk + "&" + "rhpk=" + nostrPubKey);

        connection.onopen = () => {
            log("connected");
            // connection.send("1A37F239BC1");
            connection.send(JSON.stringify({action: "info", hpk: nostrPubKey}));
            document.getElementById("conn-status").style.backgroundColor = "#32d40d";   // green
        };

        connection.onclose = () => {
            console.error("disconnected");
            document.getElementById("conn-status").style.backgroundColor = "#d40d1e";   // red
        };

        connection.onerror = error => {
            console.error("failed to connect", error);
        };

        connection.onmessage = event => {
            // log("received", event.data);

            // let li = document.createElement("li");
            // li.innerText = event.data;
            // document.querySelector("#chat").append(li);
            // let nick = document.querySelector("#nick").value;
            
            // Attempt to parse as JSON
            try {
                var json = JSON.parse(event.data);
                if (json.type == "invoice") {
                        log("Invoice Sent!");
                        document.getElementById("invoice").innerHTML = json.invoice;
                        testLN04();
                } else {
                    // log(event.data);

                    // var logger = document.querySelector("#logger");
                    // logger.innerHTML = logger.innerHTML + "\n" + event.data;
                    // logger.scrollTop = logger.scrollHeight;
                }
                return;
            } catch (e) {
                log("not json");
            }


        /*
            if (event.data.substring(2,7) == ":INV:") {
                if (event.data.substring(0,2) == nick) {
                    alert("Invoice Sent!");
                } else {
                    var invoice = event.data.substring(7);
                    document.getElementById("invoice").innerHTML = invoice;
                }
            } else {
                var logger = document.querySelector("#logger");
                logger.innerHTML = logger.innerHTML + "\n" + event.data;
                logger.scrollTop = logger.scrollHeight;
            }
        */

        };

        // document.querySelector("form").addEventListener("submit", event => {
        //     event.preventDefault();
        //     let nick = document.querySelector("#nick").value;
        //     let message = document.querySelector("#message").value;
        //     connection.send(nick + ":" + message);
        //     document.querySelector("#message").value = "";
        // });

        if (document.getElementById('reconnect')) {
            document.getElementById('reconnect').style.visibility = 'hidden';
        } 
        
        if (document.getElementById('disconnect')) {
            document.getElementById('disconnect').style.visibility = 'visible';
        }
    };

    function disconnect() {
        log("disconnecting...");
        connection.close();
        document.getElementById('reconnect').style.visibility = 'visible';
        document.getElementById('disconnect').style.visibility = 'hidden';
    };

    // document.getElementById('message').onkeydown = function(e){
    //     if(e.keyCode == 13){
    //         //log("enter key...");
    //         // let addr = document.querySelector("#addr").value;
    //         // let message = document.querySelector("#message").value;
    //         // connection.send(nick + ":" + message);
    //         // document.querySelector("#message").value = "";
    //     } else {
    //         //log("other key...");
    //     }
    // };

    reconnect();


    </script>
    <script type="module">
        // import {launchModal} from 'https://esm.sh/@getalby/bitcoin-connect@3.2.0?bundle-deps'; // jsdelivr.net, skypack.dev also work
        // import {launchModal} from 'bitcoin-connect/bitcoin-connect.js'; // local
    
        // use Bitcoin connect API normally...
        // launchModal();
    
        // or if you just want access to the web components:
        // import 'https://esm.sh/@getalby/bitcoin-connect@3.2.0';
    </script>
  
    </head>
    <body style="font-family: Tahoma, Geneva, sans-serif" onload="existsWebLN();">

    <script>

    // document.getElementById("prereqs").style.display = "none";
    // document.getElementById("mainsection").style.display = "none";

    </script>
    <!-- <div id="conn-status" style="background-color: #32d40d; position: fixed; top: 0; left: 0; width: 100%; height: 4px;"></div> -->
    <!-- <div id="conn-status" style="background-color: #d40d1e; position: fixed; top: 0; left: 0; width: 100%; height: 4px;"></div> -->
    <!-- <div id="conn-status" style="background-color: #eae30c; position: fixed; top: 0; left: 0; width: 100%; height: 4px;"></div> -->
    <div id="conn-status" style="background-color: #e6e6e6; position: fixed; top: 0; left: 0; width: 100%; height: 4px;"></div>
    <div id="prereqs">
        <h3>Prerequisites</h3>
        <p>
            TimeIntoCrypto requires that a Lightning Node Provider be installed. <br />
            The <a href="https://getalby.com/" target="get_ext">Alby Browser Extension</a> is recommended. <br />
            Install an extension and reload this page. <br />
        </p>
    </div>

    <div id="mainsection" style="display: none;" >

    <div id="tokendiv" style="display: none;" >
    <table border="0" cellspacing="1" cellpadding="2">
    <tr><th align="right">Name</th><th>Description</th></tr>
    <tr><td align="right"><a href="/oauth/test-token" target="getauth">Auth</a></td><td><textarea rows="4" cols="60" id="bearertoken" disabled>No Bearer Token Found.</textarea></td></tr>
    <!-- <tr><td align="right">Body</td><td><textarea rows="14" cols="60" id="postbody">{{body}}</textarea></td></tr> -->
    </table>
    </div>

    <!-- <button id="onboard">Loading...</button> <div id="chainlist" style="display: inline">Add a Theta network to your MetaMask with <a href="https://chainlist.org/?search=theta" target="chainlist">ChainList</a></div><br /> -->
    <!-- <textarea rows="1" cols="80" id="nick"></textarea> -->
    <table border="0" cellspacing="1" cellpadding="0">
        <!-- <tr><th align="right">Name</th><th>Description</th></tr> -->
        <tr><td align="right">Nick:</td><td><input type="text" id="nick" size="14" style="font-family: monospace" onInput="showCurrentValue(event)" /></td></tr>
        <tr><td align="right">LNPubKey:</td><td><input type="text" id="lnpubkey-field" size="66" style="font-family: monospace" /></td></tr>
        <tr><td align="right">NostrPubKey:</td><td><input type="text" id="nostrpubkey-field" size="66" style="font-family: monospace" /></td></tr>
    </table>
    <!-- <input cols="80" id="nick"></input> -->
    <form id="chatform">
        <textarea rows="1" cols="72" id="message"></textarea>
        <button type="submit" id="send">Send</button>
        <br />
        <textarea rows="7" cols="80" id="logger"></textarea>
        <br />
        <textarea rows="5" cols="80" id="invoice">No Invoice Yet!</textarea>
        <br />
    </form>

    <p id="demo"></p>

    <button onclick="myVar = setInterval(myTimer ,1000)">Start Timer</button>
    <button onclick="clearInterval(myVar)">Stop Timer</button>
    <button id="disconnect" onclick="disconnect()">Disconnect</button>
    <button id="reconnect" onclick="reconnect()" style="visibility: hidden">Connect</button>

    <button id="test01" onclick="doTestWS01()">Test 01</button>
    <button id="test02" onclick="testLN02()">Test 02 : GetInfo</button>
    <button id="test03" onclick="testLN03()">Test 03 : MakeInvoice</button>
    <button id="test04" onclick="testLN04()">Test 04 : SendPayment</button>
    <button id="test05" onclick="testLN05()">Test 05 : SignMessage</button>
    <button id="test06" onclick="testLN06()">Test 06 : VerifyMessage</button>

    <br />

    <button id="mode-button" onclick="switchMode()">Mode: Unknown</button> <a id="schedule-link" href="http://localhost:8080/?hpk=unknown&relay=wss%3A%2F%2Frelay.primal.net">Schedule Link: http://localhost:8080/?hpk=unknown&relay=wss://relay.primal.net</a>

    <ul id="chat"></ul>

    </div>

    <!-- <script src="main.js?tenantid={{tenantid}}"></script> -->
    <!-- <script
    src="https://unpkg.com/webln@0.3.2/dist/webln.min.js"
    integrity="sha384-MpjpvOQqXz9nCoLUS/sR0bhLwGYuNPMOBN50jsqhnqAzDq0GiOI0u6oC5fHitzI2"
    crossorigin="anonymous"
    ></script> -->

    <script>
    var input = document.getElementById("message");
    input.addEventListener("keypress", function(event) {
    if (event.key === "Enter") {
        event.preventDefault();
        document.getElementById("send").click();
    }
    });

    function getCookie(cname) {
    let name = cname + "=";
    let ca = document.cookie.split(';');
    for(let i = 0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) == ' ') {
        c = c.substring(1);
        }
        if (c.indexOf(name) == 0) {
        return c.substring(name.length, c.length);
        }
    }
    return "";
    }

    var bearerToken = "I am a BEARer";

    function checkForAuthToken()
    {
        bearerToken = getCookie("access_token");

        if (bearerToken != "") {
            document.getElementById("bearertoken").value = bearerToken;

        } else {
            document.getElementById("bearertoken").value = "Click Auth to get a valid bearer token.\nThen return here and reload the page.";
        }
    }

    </script>

    <script src="webln_handlers.js"></script>
    

    <!-- <script src="metamask-onboarding.bundle.js"></script> -->
    <!-- <script src="metamask-onboarding.js"></script> -->
    <!-- <script>updateButton();</script> -->

    <script>
        var dm = {};
        // https://guides.getalby.com/developer-guide/v/alby-browser-extension-apis/
        async function getNostrPubKey() {
            nostrPubKey = await window.nostr.getPublicKey();
            // Your code here
            log("NostrPubKey: " + nostrPubKey);
            document.getElementById("nostrpubkey-field").value = nostrPubKey;
            getHrefParts();
            setScheduleLink();
            if ((typeof npk) != "undefined") {
                if (npk != nostrPubKey) {
                    npk = nostrPubKey;
                    (async function() {
                        await getLNPubKey(null, null);
                    })();
                }
            }

            
            if (hpk != nostrPubKey) {
                dm = await makeDMto("This is a secret " + Math.floor(Math.random() * 100), hpk); // to Receiver
            }
            // dm = await makeDMto("This is a secret to horologger " + Math.floor(Math.random() * 10), "6771ce6cf4a229db78fa8fcf092c943580d186145baa1218b60070f116ba99ff"); // to Horologger
            // dm = await makeDMto("This is a secret to vacuum8 " + Math.floor(Math.random() * 10), "7bdef7f39298dc57996c9b7adc08db1eeaf02208437ba01bf4cbe2e8c17a72a5"); // to Vacuum8
            
            // ev = await makeEVto("This is a public message");

            disconnect();
            reconnect();
        }

        function accountChangedHandler() {
            // log("Account Changed!");

            (async function() {
                await getNostrPubKey();
            })();
            (async function() {
                await getLNPubKey(null, null);
            })();
            setScheduleLink();
            getHrefParts();
        }

        if ((typeof nostr != 'undefined') && (nostr.on)) { 
            log('nostr supported'); 
            nostr.on("accountChanged", accountChangedHandler); // callback is executed once account is changed in provided with multiple accounts
        } else {
            log('nostr not supported'); 
        }

        function doTestWS01() {
            log("doTestWS01");
            (async function() {
                await testWS01();
            })();
        }

        async function testWS01() {
            log("testWS01");
            var ev = {};
            ev = await makeEVto("Cool test message");

            const eventTask = {
                action: "post",
                relay: "wss://relay.primal.net",
                event: ev
            }

            connection.send(JSON.stringify(eventTask));
        }

        async function makeEVto(msg) {
            const event = {
                created_at: Math.round((new Date()).getTime() / 1000),
                kind: 1,
                content: msg,
                tags: [],
            };
            const signedevt = await window.nostr.signEvent(event);
            // log("makeEVto: " + JSON.stringify(signedevt, null, 2));
            // log("makeEVto: " + JSON.stringify(signedevt));
            log("echo '" + JSON.stringify(signedevt) + "' | nak event wss://relay.primal.net");
            return signedevt;
        }

        async function makeDMto(msg, pubkey) {
            const encrypted = await window.nostr.nip04.encrypt(pubkey, msg);
            const event = {
                created_at: Math.round((new Date()).getTime() / 1000),
                kind: 4,
                content: encrypted,
                tags: [['p',pubkey]],
            };
            const signedEvent = await window.nostr.signEvent(event);
            // log("makeDMto: " + JSON.stringify(signedEvent, null, 2));
            log("echo '" + JSON.stringify(signedEvent) + "' | nak event wss://relay.primal.net");
            return signedEvent;
        }


    </script>
    <ul id="webln-div">Nothing Yet!</ul>

    <!-- Bitcoin Connect components are now available -->
    <bc-button></bc-button>

    <script>
        function myTimer() {
            const d = new Date();
            document.getElementById("demo").innerHTML = d.toLocaleTimeString();
        };
    </script>
    

    </body>
</html>
