<!DOCTYPE html>
<html lang="en" dir="ltr">
    <head>
    <meta charset="utf-8" />
    <title>Web Socket Demo</title>
    <script>
    var bitcoinPrice = 0;
    function log(message)
    {
        console.log(message);
        var loggdiv = document.getElementById("logger");
        if (loggdiv) {
            loggdiv.innerHTML = loggdiv.innerHTML + "\n" + message;
            loggdiv.scrollTop = loggdiv.scrollHeight;
        }
    }
    </script>

    <script>
    (function () {
        var onWindowLoad = function () {
            
            var loadScript = function (src, callback) {
            
                var element = document.createElement("script");
                    element.src = src;
                    element.async = true;
                    document.body.appendChild(element);
                    
                    if (callback) {
                    
                        element.onreadystatechange = function () {
                            if (this.readyState === "loaded" || this.readyState === "complete") { 
                                callback();
                            }
                        };
                        element.onload = callback;
                    }
            },
            
            loadArticleScript = function () {
                // checkForAuthToken();
            };
            loadScript("jquery.min.js", loadArticleScript);
        };

        if (window.addEventListener) {
            window.addEventListener("load", onWindowLoad, false);
        } else if (window.attachEvent) {
            window.attachEvent("onload", onWindowLoad);
        } else {
            window.onload = onWindowLoad;
        }
    }());			

    function doGetNick()
    {

        var pathAndParams = '{{base}}/getNickFromPubKey';

        xhr = new XMLHttpRequest();
        xhr.open('POST', pathAndParams);

        xhr.setRequestHeader("Content-Type", "application/json");
        xhr.setRequestHeader("Accept", "application/json");

        var request_obj = { 
            "pubkey": document.getElementById("lnpubkey-field").value
        };

        xhr.onload = function() {
            
            if (xhr.status == 200) {

                var isJsonBody = false;
                var headers = xhr.getAllResponseHeaders();
                const hdrs = headers.split('\r\n');
                hdrs.forEach(function(hdr){
                    var parts = hdr.split(':');
                    if (parts[0] == "content-type") {
                        var bits = parts[1].split(';');
                        if (bits[0].trim() == "application/json") {
                            isJsonBody = true;
                        }
                    }
                });

                if (isJsonBody) {
                    var response = JSON.parse(xhr.responseText);
                    log(response);
                    document.getElementById("nick").value = response.nick;
                    // if (window.location.href.search("tenantid") < 0) {
                    //     window.location.href = window.location.href + "?tenantid=" + response.tenant;
                    // }
                }
            } 
            else {
                document.getElementById("nick").innerHTML = "Unexpected";
            }
        };

        xhr.send(JSON.stringify(request_obj));

    }

    async function getLNPubKey(req, res) {
        try {
            // const webln = await WebLN.requestProvider();
            const info = await window.webln.getInfo();
            if (typeof info.node.pubkey == 'undefined') {
                document.getElementById("lnpubkey-field").value = "Alby accounts do not have a pubkey.";
            } else {
                document.getElementById("lnpubkey-field").value = info.node.pubkey;
            }
            document.getElementById("nick").value = info.node.alias;
            // doGetNick();
        }
        catch(err) {
            // Tell the user what went wrong
            log(err.message);
            alert(err.message);
        }
    };

    async function enableWebLN() {
        log("enabling WebLN");
        await window.webln.enable();
        log("WebLN enabled");
        await getLNPubKey(null, null);
        log("got LNPubKey");
        await getNostrPubKey();
        log("got NostrPubKey");
        
    };

    // https://github.com/getAlby/js-sdk
    function existsWebLN() {
        // if (((typeof window.webln) == "object") && ((typeof window.webln.enabled) == "boolean")) {
        if (typeof window.webln !== 'undefined') {
            document.getElementById("prereqs").style.display = "none";
            document.getElementById("mainsection").style.display = "block";
            log("WebLN found");
            (async function() {
                await enableWebLN();
            })();
        }
        else {
            document.getElementById("prereqs").style.display = "block";
            document.getElementById("mainsection").style.display = "none";
            log("WebLN not found");
        }
    };

    var nostrPubKey = "unknown";

    var loc_href = "http://localhost:8080/?hpk=7bde...72a5&relay=wss://domas.io";   // urlencoded??
    var loc_proto = "http:";
    var loc_host = "localhost:8080";    // actually host:port
    var loc_http = "http://localhost:8080";
    var hpk = "aaabbb";
    var relay = "wss://relay.primal.net"

    function getHrefParts() {
        log("getHrefParts");
        loc_href = window.document.location.href;
        log("loc_href: " + loc_href);
        loc_proto = window.document.location.protocol;
        log("loc_proto: " + loc_proto);
        loc_host = window.document.location.host;
        log("loc_host: " + loc_host);
        loc_http = window.document.location.origin;
        const queryString = window.location.search;
        console.log(queryString);
        const urlParams = new URLSearchParams(queryString);

        if (urlParams.has('hpk')) {
            hpk = urlParams.get('hpk');
        } else {
            hpk = nostrPubKey;
        }

        log("hpk: " + hpk);

        if (urlParams.has('relay')) {   // wss%3A%2F%2Frelay.getalby.com%2Fv1
            relay = urlParams.get('relay');
        }
        log("relay: " + relay);

        // if (loc_href.search("hpk") > 0) {
        //     var sched_link = loc_http + "?hpk=" + nostrPubKey;
        //     document.getElementById("schedule-link").href = sched_link;
        //     document.getElementById("schedule-link").innerHTML = "My Schedule Link: " + sched_link;
        //     if (hpk != nostrPubKey) {
        //         document.getElementById("mode-button").innerHTML = "Mode: Guest";
        //     } else {
        //         document.getElementById("mode-button").innerHTML = "Mode: Host";
        //     }
        // }
        // else {
        //     loc_http = loc_href.split("?")[0];
        //     log("loc_http: " + loc_http);
        //     var sched_link = loc_http + "?hpk=" + nostrPubKey;
        //     document.getElementById("schedule-link").href = sched_link;
        //     document.getElementById("schedule-link").innerHTML = "My Schedule Link: " + sched_link;
        //     document.getElementById("mode-button").innerHTML = "Mode: Host";
        // }
    }

    getHrefParts();

    function setScheduleLink() {
        log("setScheduleLink");
        var sched_link = loc_http + "/?hpk=" + nostrPubKey + "&relay=" + relay;
            document.getElementById("schedule-link").href = sched_link;
            document.getElementById("schedule-link").innerHTML = "My Schedule Link: " + sched_link;
            if (hpk != nostrPubKey) {
                document.getElementById("mode-button").innerHTML = "Mode: Reservation";
            } else {
                document.getElementById("mode-button").innerHTML = "Mode: Availablity";
                // document.getElementById("mode-button").innerHTML = "Mode: Confirmation";
            }
    }

    function getTimeSlots() {
        log("getTimeSlots");
        connection.send(JSON.stringify({action: "getTimeSlots", hpk: hpk}));
    }

    function clearTimeSlots() {
        log("clearTimeSlots");
        var tstable = document.getElementById("time-slots-table");
        while (tstable.rows.length > 2) {   // Save the first row as the input row for new entries
            tstable.deleteRow(-1);
        }
    }

    function redrawTimeSlots(slots) {
        log("redrawTimeSlots");
        clearTimeSlots();

                // recalcUSD("recalc");
        var tstable = document.getElementById("time-slots-table");
        var ridx = 0;
        var newRow = {};
        var newCell = {};
        slots.forEach(function(slot) {

            log("slot: " + JSON.stringify(slot, null, 2));
            ridx = 0;
            var sDate = new Date(slot.start);
            var ts_year = sDate.getFullYear();
            var ts_month = sDate.getMonth() + 1;
            if (ts_month < 10) { ts_month = "0" + ts_month; }
            var ts_day = sDate.getDate();
            if (ts_day < 10) { ts_day = "0" + ts_day; }
            var ts_hour = sDate.getHours();
            if (ts_hour < 10) { ts_hour = "0" + ts_hour; }
            var ts_minute = sDate.getMinutes();
            if (ts_minute < 10) { ts_minute = "0" + ts_minute; }
            var sDuration = parseInt(slot.duration);


            // Need satsmin and usd for checking if the price is still acceptable

            var ts_satsmin = parseInt(slot.satsmin);
            var ts_quote = parseFloat(slot.quote);
            var ts_currency = "";   // USD, EUR, GBP, etc.

            newRow = tstable.insertRow(-1);
            newCell = newRow.insertCell(ridx++);
            newCell.innerHTML = "<input type='text' size='4' disabled value='" + ts_year + "'/>";
            newCell = newRow.insertCell(ridx++);
            newCell.innerHTML = "-";
            newCell = newRow.insertCell(ridx++);
            newCell.innerHTML = "<input type='text' size='2' disabled value='" + ts_month + "'/>";
            newCell = newRow.insertCell(ridx++);
            newCell.innerHTML = "-";
            newCell = newRow.insertCell(ridx++);
            newCell.innerHTML = "<input type='text' size='2' disabled value='" + ts_day + "'/>";
            newCell = newRow.insertCell(ridx++);
            newCell.innerHTML = "&nbsp;";
            newCell = newRow.insertCell(ridx++);
            newCell.innerHTML = "<input type='text' size='2' disabled value='" + ts_hour + "'/>";
            newCell = newRow.insertCell(ridx++);
            newCell.innerHTML = ":";
            newCell = newRow.insertCell(ridx++);
            newCell.innerHTML = "<input type='text' size='2' disabled value='" + ts_minute + "'/>";
            newCell = newRow.insertCell(ridx++);
            newCell.innerHTML = "&nbsp;";
            newCell = newRow.insertCell(ridx++);
            newCell.innerHTML = "<input type='text' size='4' style='text-align: right;' disabled value='" + sDuration + "'/>";
            newCell = newRow.insertCell(ridx++);
            newCell.innerHTML = "&nbsp;";
            newCell = newRow.insertCell(ridx++);
            newCell.innerHTML = "<input type='text' size='6' style='text-align: right;' disabled value='" + ts_satsmin + "'/>";
            newCell = newRow.insertCell(ridx++);
            newCell.innerHTML = "&nbsp;";
            newCell = newRow.insertCell(ridx++);
            newCell.innerHTML = "<input type='text' size='7' style='text-align: right;' disabled value='" + ts_quote + "'/>";
            newCell = newRow.insertCell(ridx++);
            newCell.innerHTML = "&nbsp;";
            newCell = newRow.insertCell(ridx++);
            newCell.innerHTML = "<button onclick='delTSrow(" + tstable.rows.length + ")'  style='visibility: block'>Delete TimeSlot</button> slot.id: " + slot.id + " slot.state: " + slot.state;

        });
    }

    function switchMode() {
        log("switchMode");
    }

    var connection = null;

    function reconnect() {

        var wsproto = "wss:";
        if (loc_proto == "http:") {
            wsproto = "ws:";
        }
        connection = new WebSocket(wsproto + "//" + loc_host + "/?" + "shpk=" + hpk + "&" + "rhpk=" + nostrPubKey);

        connection.onopen = () => {
            log("connected");
            // connection.send("1A37F239BC1");
            // connection.send(JSON.stringify({action: "info", hpk: nostrPubKey, relay: relay}));
            connection.send(JSON.stringify({action: "info", hpk: hpk, relay: relay}));
            document.getElementById("conn-status").style.backgroundColor = "#32d40d";   // green
            setTSdefaults();
        };

        connection.onclose = () => {
            console.error("disconnected");
            document.getElementById("conn-status").style.backgroundColor = "#d40d1e";   // red
        };

        connection.onerror = error => {
            console.error("failed to connect", error);
        };

        connection.onmessage = event => {
            // log("received", event.data);

            // let li = document.createElement("li");
            // li.innerText = event.data;
            // document.querySelector("#chat").append(li);
            // let nick = document.querySelector("#nick").value;
            
            // Attempt to parse as JSON
            try {
                var json = JSON.parse(event.data);
                if (json.type == "invoice") {
                        log("Invoice Sent!");
                        document.getElementById("invoice").innerHTML = json.invoice;
                        testLN04();
                } else if (json.type == "info"){
                    document.getElementById("receiver-info").innerHTML = json.info;
                } else if (json.type == "time"){
                    document.getElementById("server-time").innerHTML = json.time;
                } else if (json.type == "price"){
                    bitcoinPrice = parseInt(json.price);
                    document.getElementById("webln-div").innerHTML = bitcoinPrice;
                    recalcUSD("recalc");
                } else if (json.type == "timeslots"){
                    redrawTimeSlots(json.slots);
                } else {
                    log(event.data);
                }
                return;
            } catch (e) {
                log("not json");
            }


        /*
            if (event.data.substring(2,7) == ":INV:") {
                if (event.data.substring(0,2) == nick) {
                    alert("Invoice Sent!");
                } else {
                    var invoice = event.data.substring(7);
                    document.getElementById("invoice").innerHTML = invoice;
                }
            } else {
                var logger = document.querySelector("#logger");
                logger.innerHTML = logger.innerHTML + "\n" + event.data;
                logger.scrollTop = logger.scrollHeight;
            }
        */

        };

        // document.querySelector("form").addEventListener("submit", event => {
        //     event.preventDefault();
        //     let nick = document.querySelector("#nick").value;
        //     let message = document.querySelector("#message").value;
        //     connection.send(nick + ":" + message);
        //     document.querySelector("#message").value = "";
        // });

        if (document.getElementById('reconnect')) {
            document.getElementById('reconnect').style.visibility = 'hidden';
        } 
        
        if (document.getElementById('disconnect')) {
            document.getElementById('disconnect').style.visibility = 'visible';
        }
    };

    function disconnect() {
        log("disconnecting...");
        connection.close();
        document.getElementById('reconnect').style.visibility = 'visible';
        document.getElementById('disconnect').style.visibility = 'hidden';
    };

    // document.getElementById('message').onkeydown = function(e){
    //     if(e.keyCode == 13){
    //         //log("enter key...");
    //         // let addr = document.querySelector("#addr").value;
    //         // let message = document.querySelector("#message").value;
    //         // connection.send(nick + ":" + message);
    //         // document.querySelector("#message").value = "";
    //     } else {
    //         //log("other key...");
    //     }
    // };

    reconnect();


    </script>
    <script type="module">
        // import {launchModal} from 'https://esm.sh/@getalby/bitcoin-connect@3.2.0?bundle-deps'; // jsdelivr.net, skypack.dev also work
        // import {launchModal} from 'bitcoin-connect/bitcoin-connect.js'; // local
    
        // use Bitcoin connect API normally...
        // launchModal();
    
        // or if you just want access to the web components:
        // import 'https://esm.sh/@getalby/bitcoin-connect@3.2.0';
    </script>
  
    </head>
    <body style="font-family: Tahoma, Geneva, sans-serif" onload="existsWebLN();">

    <script>

    // document.getElementById("prereqs").style.display = "none";
    // document.getElementById("mainsection").style.display = "none";

    </script>
    <!-- <div id="conn-status" style="background-color: #32d40d; position: fixed; top: 0; left: 0; width: 100%; height: 4px;"></div> -->
    <!-- <div id="conn-status" style="background-color: #d40d1e; position: fixed; top: 0; left: 0; width: 100%; height: 4px;"></div> -->
    <!-- <div id="conn-status" style="background-color: #eae30c; position: fixed; top: 0; left: 0; width: 100%; height: 4px;"></div> -->
    <div id="conn-status" style="background-color: #e6e6e6; position: fixed; top: 0; left: 0; width: 100%; height: 4px;"></div>
    <div id="prereqs">
        <h3>Prerequisites</h3>
        <p>
            TimeIntoCrypto requires that a Lightning Node Provider be installed. <br />
            The <a href="https://getalby.com/" target="get_ext">Alby Browser Extension</a> is recommended. <br />
            Install an extension and reload this page. <br />
        </p>
    </div>

    <div id="mainsection" style="display: none;" >

    <div id="tokendiv" style="display: none;" >
    <table border="0" cellspacing="1" cellpadding="2">
    <tr><th align="right">Name</th><th>Description</th></tr>
    <tr><td align="right"><a href="/oauth/test-token" target="getauth">Auth</a></td><td><textarea rows="4" cols="60" id="bearertoken" disabled>No Bearer Token Found.</textarea></td></tr>
    <!-- <tr><td align="right">Body</td><td><textarea rows="14" cols="60" id="postbody">{{body}}</textarea></td></tr> -->
    </table>
    </div>

    <!-- <button id="onboard">Loading...</button> <div id="chainlist" style="display: inline">Add a Theta network to your MetaMask with <a href="https://chainlist.org/?search=theta" target="chainlist">ChainList</a></div><br /> -->
    <!-- <textarea rows="1" cols="80" id="nick"></textarea> -->
    <table border="0" cellspacing="1" cellpadding="0">
        <!-- <tr><th align="right">Name</th><th>Description</th></tr> -->
        <tr><td align="right">Nick:</td><td><input type="text" id="nick" size="14" style="font-family: monospace" onInput="showCurrentValue(event)" /></td></tr>
        <tr><td align="right">LNPubKey:</td><td><input type="text" id="lnpubkey-field" size="66" style="font-family: monospace" /></td></tr>
        <tr><td align="right">NostrPubKey:</td><td><input type="text" id="nostrpubkey-field" size="66" style="font-family: monospace" /></td></tr>
    </table>
    <!-- <input cols="80" id="nick"></input> -->
    <form id="chatform">
        <textarea rows="1" cols="72" id="message"></textarea>
        <button type="submit" id="send">Send</button>
        <br />
        <textarea rows="7" cols="80" id="logger"></textarea>
        <br />
        <textarea rows="5" cols="80" id="invoice">No Invoice Yet!</textarea>
        <br />
    </form>

    <script>
            function addTSrow() {
                recalcUSD("recalc");
                var tstable = document.getElementById("time-slots-table");
                var ts_year = parseInt((document.getElementById("ts-year")).value);
                var ts_month = parseInt((document.getElementById("ts-month")).value);
                if (ts_month < 10) { ts_month = "0" + ts_month; }
                var ts_day = parseInt((document.getElementById("ts-day")).value);
                if (ts_day < 10) { ts_day = "0" + ts_day; }
                var ts_hour = parseInt((document.getElementById("ts-hour")).value);
                if (ts_hour < 10) { ts_hour = "0" + ts_hour; }
                var ts_minute = parseInt((document.getElementById("ts-minute")).value);
                if (ts_minute < 10) { ts_minute = "0" + ts_minute; }
                var ts_duration = parseInt((document.getElementById("ts-duration")).value);
                var ts_satsmin = parseInt((document.getElementById("ts-satsmin")).value);
                var ts_usd = parseInt((document.getElementById("ts-usd")).value);

                var newRow = tstable.insertRow(-1);
                var ridx = 0;
                var newCell = newRow.insertCell(ridx++);
                newCell.innerHTML = "<input type='text' size='4' disabled value='" + ts_year + "'/>";

                newCell = newRow.insertCell(ridx++);
                newCell.innerHTML = "-";

                newCell = newRow.insertCell(ridx++);
                newCell.innerHTML = "<input type='text' size='2' disabled value='" + ts_month + "'/>";

                newCell = newRow.insertCell(ridx++);
                newCell.innerHTML = "-";

                newCell = newRow.insertCell(ridx++);
                newCell.innerHTML = "<input type='text' size='2' disabled value='" + ts_day + "'/>";

                newCell = newRow.insertCell(ridx++);
                newCell.innerHTML = "&nbsp;";

                newCell = newRow.insertCell(ridx++);
                newCell.innerHTML = "<input type='text' size='2' disabled value='" + ts_hour + "'/>";

                newCell = newRow.insertCell(ridx++);
                newCell.innerHTML = ":";

                newCell = newRow.insertCell(ridx++);
                newCell.innerHTML = "<input type='text' size='2' disabled value='" + ts_minute + "'/>";

                newCell = newRow.insertCell(ridx++);
                newCell.innerHTML = "&nbsp;";

                newCell = newRow.insertCell(ridx++);
                newCell.innerHTML = "<input type='text' size='4' disabled value='" + ts_duration + "'/>";

                newCell = newRow.insertCell(ridx++);
                newCell.innerHTML = "&nbsp;";

                newCell = newRow.insertCell(ridx++);
                newCell.innerHTML = "<input type='text' size='6' disabled value='" + ts_satsmin + "'/>";

                newCell = newRow.insertCell(ridx++);
                newCell.innerHTML = "&nbsp;";

                newCell = newRow.insertCell(ridx++);
                newCell.innerHTML = "<input type='text' size='7' disabled value='" + ts_usd + "'/>";

                newCell = newRow.insertCell(ridx++);
                newCell.innerHTML = "&nbsp;";

                newCell = newRow.insertCell(ridx++);
                newCell.innerHTML = "<button onclick='delTSrow(" + tstable.rows.length + ")'  style='visibility: block'>Delete TimeSlot</button>";

            }
            function delTSrow(rowNum) {
                console.log("rowNum: " + rowNum);
                var tstable = document.getElementById("time-slots-table");
                console.log("tstable.rows.length: " + tstable.rows.length);
                tstable.deleteRow(-1);
            }

            function isNumberKey(evt) {
                // console.log(JSON.stringify(evt, null, 2));
                var charCode = (evt.which) ? evt.which : evt.keyCode
                console.log("charCode: " + charCode);
                if ((charCode == 8) || (charCode == 9)) return true; // backspace or tab
                if ((charCode < 48) || (charCode > 57)) {
                    return false;
                }
                return true;
            }

            function recalcUSD(event)
            {  
                const isNum = isNumberKey(event);
                if (isNum || (event == "recalc")) {
                
                    var ts_duration = parseInt((document.getElementById("ts-duration")).value);
                    var ts_satsmin = parseInt((document.getElementById("ts-satsmin")).value);
                    var usdAmt = (((ts_duration * ts_satsmin) / 100000000) * bitcoinPrice).toFixed(2);
                    // let usdAmtStr = "$" + usdAmt;
                    document.getElementById("ts-usd").value = usdAmt;
                    console.log("usdAmt: " + usdAmt);
                }
                return isNum;
            }

            function setTSdefaults() {

                const n = new Date();
                const d = new Date(n.getTime() + (60 * 60 * 1000 * 2) + (29 * 60 * 1000));  // 2 hours and 29 minutes from now
                var y = d.getFullYear();
                var m = d.getMonth() + 1;
                if (m < 10) { m = "0" + m; }
                var day = d.getDate();
                if (day < 10) { day = "0" + day; }
                var h = d.getHours();
                if (h < 10) { h = "0" + h; }
                var min = d.getMinutes();
                if (min > 30) { min = "30"; } else { min = "00"; }
                // console.log("y: " + y + " m: " + m + " day: " + day + " h: " + h + " min: " + min);

                var ts_year = document.getElementById("ts-year"); ts_year.value = y;
                var ts_month = document.getElementById("ts-month"); ts_month.value = m;
                var ts_day = document.getElementById("ts-day"); ts_day.value = day;
                var ts_hour = document.getElementById("ts-hour"); ts_hour.value = h;
                var ts_minute = document.getElementById("ts-minute"); ts_minute.value = min;
 
            }

    </script>
    <table id="time-slots-table" border="0" cellspacing="0" cellpadding="0">
    <tr id="rowtr" style="font-family: monospace; font-size: smaller;" >
        <th align="center">Year</th><th align="center">-</th>
        <th align="center">Mon</th><th align="center">-</th>
        <th align="center">Day</th><th align="center">&nbsp;</th>
        <th align="center">Hour</th><th align="center">:</th>
        <th align="center">Min</th><th align="center">&nbsp;</th>
        <th align="center">Dur</th><th align="center">&nbsp;</th>
        <th align="center">Sats/Min</th><th align="center">&nbsp;</th>
        <th align="center">USD</th><th align="center">&nbsp;</th>
        <th align="left">Action</th>
    </tr>
    <tr id="row00" style="font-family: monospace">
        <td align="right"><input id="ts-year"     type="text" size="4" value="2024"/></td><td align="center">-</td>
        <td align="right"><input id="ts-month"    type="text" size="2" value="03"/></td><td align="center">-</td>
        <td align="right"><input id="ts-day"      type="text" size="2" value="12"/></td><td align="center">&nbsp;</td>
        <td align="right"><input id="ts-hour"     type="text" size="2" value="13"/></td><td align="center">:</td>
        <td align="right"><input id="ts-minute"   type="text" size="2" value="00"/></td><td align="center">&nbsp;</td>
        <td align="right"><input id="ts-duration" type="text" size="4" value="30" style="text-align: right;" onkeypress="return recalcUSD(event)" /></td><td align="center">&nbsp;</td>
        <td align="right"><input id="ts-satsmin"  type="text" size="6" value="1000" style="text-align: right;" onkeypress="return recalcUSD(event)" /></td><td align="center">&nbsp;</td>
        <td align="center"><input id="ts-usd"     type="text" size="7" value="calc" disabled style="text-align: right;"/></td><td align="center">&nbsp;</td>
        <td align="left">
            <button id="test01" onclick="addTSrow()"  style="visibility: block">Add TimeSlot</button>
            <!-- <button id="test01" onclick="addTSrow()"  style="visibility: hidden">Reserve</button> -->
        </td>
    </tr>
    </table>

    <p id="demo"></p>

    <button onclick="myVar = setInterval(myTimer ,1000)">Start Timer</button>
    <button onclick="clearInterval(myVar)">Stop Timer</button>
    <button id="disconnect" onclick="disconnect()">Disconnect</button>
    <button id="reconnect" onclick="reconnect()" style="visibility: hidden">Connect</button>

    <button id="test01" onclick="doTestWS01()">Test 01 : DM</button>
    <button id="test02" onclick="doTestWS02()">Test 02 : EV</button>
    <!-- <button id="test02" onclick="testLN02()">Test 02 : GetInfo</button> -->
    <button id="test03" onclick="testLN03()">Test 03 : MakeInvoice</button>
    <button id="test04" onclick="testLN04()">Test 04 : SendPayment</button>
    <button id="test05" onclick="testLN05()">Test 05 : SignMessage</button>
    <button id="test06" onclick="testLN06()">Test 06 : VerifyMessage</button>

    <br />

    <button id="mode-button" onclick="switchMode()">Mode: Unknown</button> <a id="schedule-link" href="http://localhost:8080/?hpk=unknown&relay=wss%3A%2F%2Frelay.primal.net">Schedule Link: http://localhost:8080/?hpk=unknown&relay=wss://relay.primal.net</a>

    <ul id="chat"></ul>

    </div>

    <!-- <script src="main.js?tenantid={{tenantid}}"></script> -->
    <!-- <script
    src="https://unpkg.com/webln@0.3.2/dist/webln.min.js"
    integrity="sha384-MpjpvOQqXz9nCoLUS/sR0bhLwGYuNPMOBN50jsqhnqAzDq0GiOI0u6oC5fHitzI2"
    crossorigin="anonymous"
    ></script> -->

    <script>
    var input = document.getElementById("message");
    input.addEventListener("keypress", function(event) {
    if (event.key === "Enter") {
        event.preventDefault();
        document.getElementById("send").click();
    }
    });

    function getCookie(cname) {
    let name = cname + "=";
    let ca = document.cookie.split(';');
    for(let i = 0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) == ' ') {
        c = c.substring(1);
        }
        if (c.indexOf(name) == 0) {
        return c.substring(name.length, c.length);
        }
    }
    return "";
    }

    var bearerToken = "I am a BEARer";

    function checkForAuthToken()
    {
        bearerToken = getCookie("access_token");

        if (bearerToken != "") {
            document.getElementById("bearertoken").value = bearerToken;

        } else {
            document.getElementById("bearertoken").value = "Click Auth to get a valid bearer token.\nThen return here and reload the page.";
        }
    }

    </script>

    <script src="webln_handlers.js"></script>
    
    <!-- <script src="metamask-onboarding.bundle.js"></script> -->
    <!-- <script src="metamask-onboarding.js"></script> -->
    <!-- <script>updateButton();</script> -->

    <script>
        var dm = {};
        // https://guides.getalby.com/developer-guide/v/alby-browser-extension-apis/
        async function getNostrPubKey() {
            nostrPubKey = await window.nostr.getPublicKey();
            // Your code here
            log("NostrPubKey: " + nostrPubKey);
            document.getElementById("nostrpubkey-field").value = nostrPubKey;
            getHrefParts();
            setScheduleLink();
            if ((typeof npk) != "undefined") {
                if (npk != nostrPubKey) {
                    npk = nostrPubKey;
                    (async function() {
                        await getLNPubKey(null, null);
                    })();
                }
            }

            
            if (hpk != nostrPubKey) {
                const damsg = "I'm checking out your timeslots. " + Math.floor(Math.random() * 100);
                log(damsg)
                dm = await makeDMto(damsg, hpk); // to Receiver
            }
            // dm = await makeDMto("This is a secret to horologger " + Math.floor(Math.random() * 10), "6771ce6cf4a229db78fa8fcf092c943580d186145baa1218b60070f116ba99ff"); // to Horologger
            // dm = await makeDMto("This is a secret to vacuum8 " + Math.floor(Math.random() * 10), "7bdef7f39298dc57996c9b7adc08db1eeaf02208437ba01bf4cbe2e8c17a72a5"); // to Vacuum8
            
            // ev = await makeEVto("This is a public message");

            getTimeSlots();


            disconnect();
            reconnect();
        }

        function accountChangedHandler() {
            // log("Account Changed!");

            (async function() {
                await getNostrPubKey();
            })();
            (async function() {
                await getLNPubKey(null, null);
            })();
            getHrefParts();
            setScheduleLink();
            // getHrefParts();
            getTimeSlots();

        }

        if ((typeof nostr != 'undefined') && (nostr.on)) { 
            log('nostr supported'); 
            nostr.on("accountChanged", accountChangedHandler); // callback is executed once account is changed in provided with multiple accounts
        } else {
            log('nostr not supported'); 
        }

        async function makeDMto(msg, pubkey) {
            log("makeDMto: " + msg + " to " + pubkey);
            const encrypted = await window.nostr.nip04.encrypt(pubkey, msg);
            const event = {
                created_at: Math.round((new Date()).getTime() / 1000),
                kind: 4,
                content: encrypted,
                tags: [['p',pubkey]],
            };
            const signedEvent = await window.nostr.signEvent(event);
            // log("makeDMto: " + JSON.stringify(signedEvent, null, 2));
            log("echo '" + JSON.stringify(signedEvent) + "' | nak event wss://relay.primal.net");

            const eventTask = {
                action: "post",
                relay: "wss://relay.primal.net",
                msg: msg,
                event: signedEvent
            }
            stashed = eventTask;
            connection.send(JSON.stringify(eventTask));

            return signedEvent;
        }

        var stashed = {};


        function doTestWS01() {
            log("doTestWS01");
            // (async function() {
            //     await testWS01();
            // })();
            log("stashed: " + JSON.stringify(stashed, null, 2));
            connection.send(JSON.stringify(stashed));
        }

        async function testWS01() {
            log("testWS01");
            var ev = {};
            // ev = await makeEVto("Cool test message");
            const sm = "Soooo secret " + Math.floor(Math.random() * 100);
            ev = await makeDMto(sm, hpk); // to Receiver

            const eventTask = {
                action: "post",
                relay: "wss://relay.primal.net",
                msg: sm,
                event: ev
            }

            connection.send(JSON.stringify(eventTask));
        }

        async function makeEVto(msg) {
            const event = {
                created_at: Math.round((new Date()).getTime() / 1000),
                kind: 1,
                content: msg,
                tags: [],
            };
            const signedevt = await window.nostr.signEvent(event);
            // log("makeEVto: " + JSON.stringify(signedevt, null, 2));
            // log("makeEVto: " + JSON.stringify(signedevt));
            log("echo '" + JSON.stringify(signedevt) + "' | nak event wss://relay.primal.net");
            return signedevt;
        }

        async function doTestWS02() {
            log("doTestWS02");
            var normal_event = {};
            // (async function() {
            //     normal_event = await testWS02();
            // })();
            normal_event = await testWS02();
            connection.send(JSON.stringify(normal_event));
        }

        async function testWS02() {
            log("testWS02");
            var ev = {};
            // ev = await makeEVto("Cool test message");
            const ne = "Normie event " + Math.floor(Math.random() * 100);
            ev = await makeEVto(ne);

            const eventTask = {
                action: "post",
                relay: "wss://relay.primal.net",
                ne: ne,
                event: ev
            }
            return eventTask;
        }



    </script>
    <ul id="server-time">Server Time!</ul>
    <ul id="receiver-info">Who Receiving!</ul>

    <ul id="webln-div">Nothing Yet!</ul>

    <!-- Bitcoin Connect components are now available -->
    <bc-button></bc-button>

    <script>
        function myTimer() {
            const timenow = Math.round((new Date()).getTime() / 1000);
            document.getElementById("demo").innerHTML = timenow;
        };
    </script>
    

    </body>
</html>
